<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact form</title>
  <!-- <link rel="stylesheet" href="./styles/styles.css"> -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- <script src="./script/main.js"></script> -->
</head>

<body>
  <div class="main">
    <form method="POST" class="form" id="form-1">
      <h3 class="heading">Đăng ký khoá học Excel</h3>
      <div class="spacer"></div>

      <div class="form-group">
        <label for="name" class="form-label">Họ và tên:</label>
        <input id="name" name="NAME" type="text" placeholder="VD: Sơn Đặng" class="form-control">
        <span class="form-message"></span>
      </div>

      <div class="form-group">
        <label for="email" class="form-label">Email:</label>
        <input id="email" name="EMAIL" type="text" placeholder="VD: email@domain.com" class="form-control">
        <span class="form-message"></span>
      </div>

      <div class="form-group">
        <label for="phone" class="form-label">Số điện thoại:</label>
        <input id="phone" name="PHONE" type="tel" minlength="0" maxlength="10" placeholder="VD: 0700000000"
          class="form-control" onkeyup="digits(this)">
        <span class="form-message"></span>
      </div>

      <div class="form-group">
        <label for="cty" class="form-label">Công ty:</label>
        <input id="cty" name="CTY" type="text" placeholder="Nhập tên công ty" class="form-control">
        <span class="form-message"></span>
      </div>

      <div class="form-group">
        <label for="job" class="form-label">Nghề nghiệp:</label>
        <input id="job" name="NGHE_NGHIEP" type="text" placeholder="Nhập nghề nghiệp" class="form-control">
        <span class="form-message"></span>
      </div>

      <div class="form-group">
        <label for="email" class="form-label">Hình thức học:</label>
        <select id="LYDO_DK" name="LYDO_DK" class="form-control">
          <option value="" selected disabled hidden>Tính năng cần sử dụng:</option>
          <option type="text" value="1.Chia sẻ Excel Qua Mạng">1. Chia sẻ Excel Qua Mạng.</option>
          <option type="text" value="2.Tạo báo cáo động Excel">2. Tạo báo cáo động Excel.</option>
          <option type="text" value="3.Nhập Liệu Nâng Cao">3. Tạo nhập tìm kiếm, tra cứu trên Excel</option>
          <option type="text" value="4.Thiết kế Excel">4. Thiết kế file sử dụng A-Tools</option>
          <option type="text" value="5.Tính năng phụ">5. Tính năng phụ đọc số thành chữ, chuyển Font,...</option>
        </select>
        <span class="form-message"></span>
      </div>

      <input type="hidden" id="IP" name="IP">
      <input type="hidden" id="LOCATION" name="LOCATION">
      <input type="hidden" id="DEVICE" name="DEVICE">

      <input type="hidden" id="MA_SP">
      <input type="hidden" id="TEN_SP">
      <input type="hidden" id="NAMEAF">
      <input type="hidden" id="NGUON">

      <button class="form-submit">Đăng ký</button>
    </form>
  </div>
</body>

</html>
<style>
  * {
    padding: 0;
    margin: 0;
    box-sizing: border-box;
  }

  html {
    color: #11a091;
    font-size: 62.5%;
    font-family: 'Open Sans', sans-serif;
  }

  .main {
    background: #ffffff;
    min-height: 100vh;
    display: flex;
    justify-content: center;
  }

  .form {
    width: 360px;
    min-height: 100px;
    padding: 32px 24px;
    text-align: center;
    background: #fff;
    border-radius: 2px;
    margin: 24px;
    align-self: center;
    box-shadow: 0 2px 5px 0 rgba(51, 62, 73, .1);
  }

  .form .heading {
    font-size: 2rem;
  }

  .form .desc {
    text-align: center;
    color: #636d77;
    font-size: 1.6rem;
    font-weight: lighter;
    line-height: 2.4rem;
    margin-top: 16px;
    font-weight: 300;
  }

  .form-group {
    display: flex;
    margin-bottom: 16px;
    flex-direction: column;
  }

  .form-label,
  .form-message {
    text-align: left;
  }

  .form-label {
    font-weight: 700;
    padding-bottom: 6px;
    line-height: 0.5rem;
    font-size: 1.4rem;
  }

  .form-control {
    height: 40px;
    padding: 8px 12px;
    border: 1px solid #b3b3b3;
    border-radius: 3px;
    outline: none;
    font-size: 1.4rem;
  }

  .form-control:hover {
    border-color: #1dbfaf;
  }

  .form-group.invalid .form-control {
    border-color: #f33a58;
  }

  .form-group.invalid .form-message {
    color: #f33a58;
  }

  .form-message {
    font-size: 1.2rem;
    line-height: 1.6rem;
    padding: 4px 0 0;
  }

  .form-submit {
    outline: none;
    background-color: #1dbfaf;
    margin-top: 2px;
    padding: 12px 16px;
    font-weight: 600;
    color: #fff;
    border: none;
    width: 100%;
    font-size: 18px;
    border-radius: 8px;
    cursor: pointer;
  }

  .form-submit:hover {
    background-color: #1ac7b6;
  }

  .spacer {
    margin-top: 16px;
  }

  /* select, textarea {
  width: calc(100%);
  padding: 8px;
  margin-bottom: 20px;
  border: 1px solid #1c87c9;
  border-radius: 4px;
  outline: none;
  font-size: 15px;
} */
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('TEN_SP').value = getParameterByName('TEN_SP');
    document.getElementById('MA_SP').value = getParameterByName('MA_SP');
    document.getElementById('NAMEAF').value = getParameterByName('NAMEAF');
    document.getElementById('NGUON').value = getParameterByName('NGUON');
    

    Validator({
      form: '#form-1',
      formGroupSelector: '.form-group',
      errorSelector: '.form-message',
      rules: [
        Validator.isRequired('#name', 'Vui lòng nhập tên đầy đủ của bạn.'),
        Validator.isEmail('#email'),
        Validator.isRequired('#phone', 'Vui lòng nhập số điện thoại.'),
        Validator.minLength('#phone', 10),
        Validator.isRequired('#LYDO_DK', 'Vui lòng chọn hình thức học.'),
      ],
      onSubmit: async function (data) {
        // Call API
        const formData = {
          ...data,
          ...getUrlParams(window.location.search),
        }

        await postForm(formData)
          .then(res => {
            // link cần huyển tới
            const link_redirect =
              'http://hocexcelnangcao.net/cam-on-dang-ky-tai-phan-mem-add-in-a-tools-a-newsdetails-36799-186-186.html';
            window.location.href = link_redirect;
          })
          .catch(err => {
            console.log('error', err)
          });
      }
    });
  });

  const getUrlParams = search => {
    const hashes = search.slice(search.indexOf('?') + 1).split('&')
    const params = {}
    hashes.map(hash => {
        const [key, val] = hash.split('=')
        params[key] = decodeURIComponent(val)
    })
    return params
  }

  const postForm = data => {
    const body = JSON.stringify(data);
    return fetch('http://api.baoninh.xyz:8080/datasnap/rest/TServerMethodsAPI/Ladipage', {
      // return fetch('http:localhost:8080/datasnap/rest/TServerMethodsAPI/Ladipage', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        user: "ninh",
        token: "baoanh21"
      },
      body,
    });
  };

  const getParameterByName = (name, url = window.location.href) => {
    console.log('name', name);
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
      results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  (function () {
    // Get IP Address
    axios.get('http://api.ipstack.com/check?access_key=07b7e3711433acddc0d5a4cfbda88e59&fbclid=IwAR0ZfsKbGnpF7UKq2NvkIFgHKelDNBvi8TSYCs5ibjDGa2iop5Pzggc-s-M')
      .then(res => {
        // handle success
        const { ip, region_name } = res.data;
        document.getElementById('IP').value = ip;
        document.getElementById('LOCATION').value = region_name;
        //document.getElementById("DEVICE").innerHTML = 'LAPTOP';
        document.getElementById('DEVICE').value = navigator.appVersion;
      })
      .catch(function (error) {
        console.log(error);
      })
  })();

  // Đối tượng `Validator`
  function Validator(options) {
    function getParent(element, selector) {
      while (element.parentElement) {
        if (element.parentElement.matches(selector)) {
          return element.parentElement;
        }
        element = element.parentElement;
      }
    }

    var selectorRules = {};

    // Hàm thực hiện validate
    function validate(inputElement, rule) {
      var errorElement = getParent(inputElement, options.formGroupSelector).querySelector(options.errorSelector);
      var errorMessage;

      // Lấy ra các rules của selector
      var rules = selectorRules[rule.selector];

      // Lặp qua từng rule & kiểm tra
      // Nếu có lỗi thì dừng việc kiểm
      for (var i = 0; i < rules.length; ++i) {
        switch (inputElement.type) {
          case 'radio':
          case 'checkbox':
            errorMessage = rules[i](
              formElement.querySelector(rule.selector + ':checked')
            );
            break;
          default:
            errorMessage = rules[i](inputElement.value);
        }
        if (errorMessage) break;
      }

      if (errorMessage) {
        errorElement.innerText = errorMessage;
        getParent(inputElement, options.formGroupSelector).classList.add('invalid');
      } else {
        errorElement.innerText = '';
        getParent(inputElement, options.formGroupSelector).classList.remove('invalid');
      }

      return !errorMessage;
    }

    // Lấy element của form cần validate
    var formElement = document.querySelector(options.form);
    if (formElement) {
      // Khi submit form
      formElement.onsubmit = function (e) {
        e.preventDefault();

        var isFormValid = true;

        // Lặp qua từng rules và validate
        options.rules.forEach(function (rule) {
          var inputElement = formElement.querySelector(rule.selector);
          var isValid = validate(inputElement, rule);
          if (!isValid) {
            isFormValid = false;
          }
        });

        if (isFormValid) {
          // Trường hợp submit với javascript
          if (typeof options.onSubmit === 'function') {
            var enableInputs = formElement.querySelectorAll('[name]');
            var formValues = Array.from(enableInputs).reduce(function (values, input) {

              switch (input.type) {
                case 'radio':
                  values[input.name] = formElement.querySelector('input[name="' + input.name + '"]:checked').value;
                  break;
                case 'checkbox':
                  if (!input.matches(':checked')) {
                    values[input.name] = '';
                    return values;
                  }
                  if (!Array.isArray(values[input.name])) {
                    values[input.name] = [];
                  }
                  values[input.name].push(input.value);
                  break;
                case 'file':
                  values[input.name] = input.files;
                  break;
                default:
                  values[input.name] = input.value;
              }

              return values;
            }, {});
            options.onSubmit(formValues);
          }
          // Trường hợp submit với hành vi mặc định
          else {
            formElement.submit();
          }
        }
      }

      // Lặp qua mỗi rule và xử lý (lắng nghe sự kiện blur, input, ...)
      options.rules.forEach(function (rule) {

        // Lưu lại các rules cho mỗi input
        if (Array.isArray(selectorRules[rule.selector])) {
          selectorRules[rule.selector].push(rule.test);
        } else {
          selectorRules[rule.selector] = [rule.test];
        }

        var inputElements = formElement.querySelectorAll(rule.selector);

        Array.from(inputElements).forEach(function (inputElement) {
          // Xử lý trường hợp blur khỏi input
          inputElement.onblur = function () {
            validate(inputElement, rule);
          }

          // Xử lý mỗi khi người dùng nhập vào input
          inputElement.oninput = function () {
            var errorElement = getParent(inputElement, options.formGroupSelector).querySelector(options.errorSelector);
            errorElement.innerText = '';
            getParent(inputElement, options.formGroupSelector).classList.remove('invalid');
          }
        });
      });
    }

  }

  // Định nghĩa rules
  // Nguyên tắc của các rules:
  // 1. Khi có lỗi => Trả ra message lỗi
  // 2. Khi hợp lệ => Không trả ra cái gì cả (undefined)
  Validator.isRequired = function (selector, message) {
    return {
      selector: selector,
      test: function (value) {
        return value ? undefined : message || 'Vui lòng nhập trường này.'
      }
    };
  }

  Validator.isEmail = function (selector, message) {
    return {
      selector: selector,
      test: function (value) {
        var regex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
        return regex.test(value) ? undefined : message || 'Trường này phải là email.';
      }
    };
  }

  Validator.minLength = function (selector, min, message) {
    return {
      selector: selector,
      test: function (value) {
        return value.length >= min ? undefined : message || `Vui lòng nhập tối thiểu ${min} kí tự.`;
      }
    };
  }

  Validator.isConfirmed = function (selector, getConfirmValue, message) {
    return {
      selector: selector,
      test: function (value) {
        return value === getConfirmValue() ? undefined : message || 'Giá trị nhập vào không chính xác.';
      }
    }
  }

  var digits = function (box) {
    box.value = box.value.replace(/[^0-9]/g, '');
  };
</script>